name: run-publish-benchmarks

on:
  push:
    branches: ["main"]

jobs:
  basic-benchmarks:
    runs-on: ubuntu-latest
    env:
      RETH_VERSION: 0c69e294c32728250280169b85727d3e7baa6402
      OP_GETH_REPO: https://github.com/snissn/op-geth
      OP_GETH_VERSION: 0d08db45cd607cd97c2aca64a5ea8cfbdb44e1d6
      # op-geth's TreeDB backend expects newer gomap APIs (e.g., DeleteRange, MemtableMode).
      # Pin an explicit gomap commit for reproducible CI builds.
      GOMAP_VERSION: b69ad617e4ead1220c86924cb0dacbdfe517b167
      # Bump to invalidate the op-geth binary cache when we change local patching behavior.
      OP_GETH_PATCH_VERSION: "1"

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@002fdce3c6a235733a90a27c80493a3241e56863 # v2.12.1
        with:
          egress-policy: audit

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          submodules: true

      - name: Set up Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v6.1.0
        with:
          go-version: "1.25.5"

      - name: Set up Rust
        uses: actions-rust-lang/setup-rust-toolchain@9399c7bb15d4c7d47b27263d024f0a4978346ba4 # v1.11.0

      - name: Install project dependencies
        run: |
          go mod download

      - name: Cache binaries
        uses: actions/cache@2f8e54208210a422b2efd51efaa6bd6d7ca8920f # v3.4.3
        id: cache-bin
        with:
          path: ${{ runner.temp }}/bin
          key: ${{ runner.os }}-binaries-reth-${{ env.RETH_VERSION }}-op-geth-${{ env.OP_GETH_VERSION }}-gomap-${{ env.GOMAP_VERSION }}-patch-${{ env.OP_GETH_PATCH_VERSION }}

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@82dee4ba654bd2146511f85f0d013af94670c4de # v1.4.0

      - name: Build Contracts
        run: |
          forge build --force

      - name: Download op-geth and reth
        if: steps.cache-bin.outputs.cache-hit != 'true'
        run: |
          mkdir -p ${{ runner.temp }}/bin

          git clone https://github.com/paradigmxyz/reth
          git -C reth checkout --force ${{ env.RETH_VERSION }}

          pushd reth
          cargo build --features asm-keccak,jemalloc --profile release --bin op-reth --manifest-path crates/optimism/bin/Cargo.toml
          cp ./target/release/op-reth ${{ runner.temp }}/bin/reth
          popd
          chmod +x ${{ runner.temp }}/bin/reth

          git clone ${{ env.OP_GETH_REPO }} op-geth
          git -C op-geth checkout --force ${{ env.OP_GETH_VERSION }}

          pushd op-geth
          # Ensure no local developer replaces leak into CI builds, and ensure the gomap
          # dependency matches the op-geth TreeDB integration expectations.
          go mod edit -dropreplace github.com/snissn/gomap 2>/dev/null || true
          # TreeDB options used by op-geth are intentionally unsafe for throughput and must be
          # explicitly acknowledged in gomap. Patch in AllowUnsafe for this pinned op-geth
          # snapshot so the binary can start in CI.
          python3 - <<'PY'
          from pathlib import Path
          path = Path("ethdb/treedb/treedb.go")
          s = path.read_text()
          if "AllowUnsafe:" not in s:
              s = s.replace("MemtableMode: memtableMode,\n", "MemtableMode: memtableMode,\n\n\t\tAllowUnsafe: true,\n")
              path.write_text(s)
          PY
          gofmt -w ethdb/treedb/treedb.go
          go get github.com/snissn/gomap@${{ env.GOMAP_VERSION }}
          go mod tidy
          # op-geth's build pipeline uses GITHUB_SHA for version metadata when present.
          # In this workflow GITHUB_SHA refers to the benchmark repo commit, which is not in
          # the op-geth git history, so ensure it points at the op-geth checkout.
          GITHUB_SHA=$(git rev-parse HEAD) make geth
          cp ./build/bin/geth ${{ runner.temp }}/bin/geth
          chmod +x ${{ runner.temp }}/bin/geth
          popd

          echo "binaries compiled:"
          ls -la ${{ runner.temp }}/bin

      - name: Run Basic Benchmarks (reth + op-geth leveldb)
        id: unit
        env:
          GETH_DB_ENGINE: leveldb
        run: |
          mkdir ${{ runner.temp }}/data-dir
          mkdir ${{ runner.temp }}/output
          go run benchmark/cmd/main.go \
            --log.level info \
            run \
            --config ./configs/public/public-benchmark.yml \
            --root-dir ${{ runner.temp }}/data-dir \
            --output-dir ${{ runner.temp }}/output \
            --reth-bin ${{ runner.temp }}/bin/reth \
            --geth-bin ${{ runner.temp }}/bin/geth

      - name: Run op-geth TreeDB Benchmarks
        run: |
          OP_GETH_TREEDB_PROFILE=safe \
          go run benchmark/cmd/main.go \
            --log.level info \
            run \
            --config ./configs/public/public-benchmark-geth-treedb.yml \
            --root-dir ${{ runner.temp }}/data-dir \
            --output-dir ${{ runner.temp }}/output \
            --reth-bin ${{ runner.temp }}/bin/reth \
            --geth-bin ${{ runner.temp }}/bin/geth

      - name: Build Report
        run: |
          cp -r ${{ runner.temp }}/output/ ./output/
          pushd report
          npm install
          npm run build
          popd

      - name: Upload static files as artifact
        id: deployment
        uses: actions/upload-pages-artifact@56afc609e74202658d3ffba0e8f6dda462b719fa # v3.0.1
        with:
          path: report/dist/

  deploy:
    runs-on: ubuntu-latest
    needs: basic-benchmarks
    permissions:
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@002fdce3c6a235733a90a27c80493a3241e56863 # v2.12.1
        with:
          egress-policy: audit

      - name: Publish Report
        uses: actions/deploy-pages@d6db90164ac5ed86f2b6aed7e0febac5b3c0c03e # v4.0.5
